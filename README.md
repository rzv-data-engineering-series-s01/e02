# Песочница для отладки процесса ревью PR

Ниже я опишу, как воспроизвести этот функционал, какие настройки нужно сделать в организации, репозиториях и как сконфигурировать маппинги функция-витрина/вьюха-овнер

## Уровень организации
Прежде всего, в Организации (org) нужно создать команды (teams). 

Если команда владеет функцией, она должна содержать "-owners" в названии. Если ответственна за зависимый от функции объект, -facilitators (н. osago-owners, market-facilitators).

В команду нужно добавить все учётные записи людей, которые будут ответственны за review изменений в объекте. Для продвижения на следующий этап достаточно хотя бы одного approve из каждой ответственной команды.

Команде нужно выдать write права на репозиторий, в котором будет запускаться пайплайн с Auto-review. У каждого члена команды будет право на создание и изменение объектов в репозитории.

В настройках команды, Scheduled reminders, настраивается связь со Slack-каналом, куда будут приходить все уведомления для этой группы, то есть для каждой команды нужно создать свой Slack канал внутри sravni Workspace'a. Связь команда-канал -- многие ко многим. 

Выбирается время (хоть каждые полчаса), остальные настройки можно оставить по умолчанию или фильтровать "мусор". Также там можно включить назначение ответственным случайного человека из команды, а не всех (в секции Code review). 

## Уровень репозитория

Добавить workflow и следующие файлы в ветку main (default). Их настройка будет описана позднее:
```
.github
  |-- workflows/pr-review-flow.yml
  |-- CODEFACILITATORS
  |-- CODEOWNERS
  |-- CODETECHTEAM
```
Settings - Rules - Rulesets: создать правило с байпасом у команды dwh и требованием хотя бы 3 аппрувов и всех успешных проверок перед разрешением merge, а также блокировку force push прямо в main ветку.

Проверить в Settings - Actions - General, что Policies разрешают запуск внешних для компании actions хотя бы для выбранных репозиториев. Здесь же в Workflow permissions нужно выдать Read and write permissions.

В разработческих настройках одного из пользователей нужно создать Personal access token (classic) с правами (как минимум, при возникновении странных ошибок попробуй докинуть больше прав):
* read:org (для чтения данных о командах)
* repo (для вытаскивания мета-данных из ревью PR)

В Settings - Secrets and variables - Actions нужно создать кастомный секрет PR_REVIEW_TOKEN, вставить токен выше. Также сохрани его в secret vault.


## Настройка связи sql файлов с командами

Связь настраивается в файлах:
* CODEFACILITATORS -- по маске указывается связь между файлами функций! и командами, ответственными за транзитивно зависимые от функции объекты (заполняется скриптом на основе других)
* CODEOWNERS -- по маске указывается связь между файлами функций и ответственными командами
* CODETECHTEAM -- указывается название dwh или другой тех. команды, для унификации подхода
* TO-DO: после отладки скрипта поиска связей заполнить CODEFACILITATORS, добавив другой конфиг файл {команда: [витрины, вьюхи и другие объекты]}

Используется формат GLOB-маски, например путь `path_to_functions/*url_to_product.sql @rzv-data-engineering-series-s01/analysts-owners` будет назначать указанную команду `analysts-owners` в организации `@rzv-data-engineering-series-s01` (будет sravni) для файлов:
```
path_to_functions/url_to_product.sql
path_to_functions/3.012356_f_url_to_product.sql
path_to_functions/anything_url_to_product.sql
```

По формату похоже на gitignore, можно назначать несколько команд в одну строку через пробел. Подробнее здесь: https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners#codeowners-syntax 

## Что это и какую проблему решает

## Что умеет

## TO-DO
